{% extends 'core/base.html' %}
{% load static %}

{% block title %}Session Replay - Clearsight{% endblock %}

{% block extra_head %}
<style>
    .viewport {
        position: relative;
        width: 100%;
        height: calc(100vh - 200px);
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #replay-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }
    
    #cursor {
        position: fixed;
        width: 20px;
        height: 20px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path d="M0 0l6 18 2.5-6L15 14 0 0z" fill="%23000"/></svg>');
        pointer-events: none;
        z-index: 9999;
        transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        display: none;
    }
    
    #cursor.clicking {
        transform: scale(0.9);
        transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #cursor.typing::after {
        content: '';
        position: absolute;
        width: 2px;
        height: 12px;
        background: #000;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0;
        }
    }
    
    .replay-container {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .replay-controls {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    
    .btn-primary {
        background: #0d6efd;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0b5ed7;
    }
    
    .form-select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ced4da;
    }
    
    .timeline {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    #progress {
        flex-grow: 1;
    }
    
    #time-display {
        min-width: 60px;
        text-align: right;
    }
    
    .alert {
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }
    
    .alert-danger {
        color: #842029;
        background-color: #f8d7da;
        border-color: #f5c2c7;
    }
    
    .alert-heading {
        margin-top: 0;
        margin-bottom: 0.5rem;
    }
    
    .mb-0 {
        margin-bottom: 0;
    }
    
    hr {
        margin: 1rem 0;
        border: 0;
        border-top: 1px solid rgba(0,0,0,.1);
    }
    
    .fade-enter {
        opacity: 0;
        transform: translateX(-20px);
    }
    
    .fade-enter-active {
        opacity: 1;
        transform: translateX(0);
        transition: opacity 300ms, transform 300ms;
    }
    
    .fade-exit {
        opacity: 1;
        transform: translateX(0);
    }
    
    .fade-exit-active {
        opacity: 0;
        transform: translateX(20px);
        transition: opacity 300ms, transform 300ms;
    }
    
    .fade-enter-done {
        transform: translateX(0);
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="replay-container">
    <div class="replay-controls">
        <button id="play-pause" class="btn btn-primary">Play</button>
        <select id="speed" class="form-select">
            <option value="0.5">0.5x</option>
            <option value="1.0" selected>1.0x</option>
            <option value="2.0">2.0x</option>
        </select>
        <div class="timeline">
            <input type="range" id="progress" min="0" max="100" value="0">
            <span id="time-display">0:00</span>
        </div>
    </div>
    
    <div class="viewport">
        <iframe id="replay-frame" sandbox="allow-same-origin allow-scripts" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>
        <div id="cursor"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/session-replay.js' %}?v={% now 'U' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Debug session data
        console.log('Raw session data:', {{ session_data|safe }});
        
        // Parse and validate session data
        const sessionData = {{ session_data|safe }};
        console.log('Parsed session data:', {
            hasData: !!sessionData,
            id: sessionData?.id,
            hasHtml: !!sessionData?.page_html,
            htmlLength: sessionData?.page_html?.length,
            hasStyles: !!sessionData?.page_styles,
            stylesLength: sessionData?.page_styles?.length,
            eventsCount: sessionData?.events?.length
        });
        
        // Initialize the replay with the session data
        window.replay = new SessionReplay(sessionData);
    } catch (error) {
        console.error('Error initializing replay:', error);
        
        // Show error to user
        const viewport = document.querySelector('.viewport');
        if (viewport) {
            viewport.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Error Initializing Replay</h4>
                    <p>${error.message}</p>
                    <hr>
                    <p class="mb-0">Please try refreshing the page. If the error persists, contact support.</p>
                </div>
            `;
        }
    }
});
</script>
{% endblock %}
